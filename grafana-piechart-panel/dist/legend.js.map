{"version":3,"sources":["../src/legend.js"],"names":[],"mappings":"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","file":"legend.js","sourcesContent":["import angular from 'angular';\n//import _ from  'lodash';\nimport kbn from 'app/core/utils/kbn';\nimport $ from  'jquery';\nimport 'jquery.flot';\nimport 'jquery.flot.time';\n\nangular.module('grafana.directives').directive('piechartLegend', function(popoverSrv, $timeout) {\n  return {\n    link: function(scope, elem) {\n      var $container = $('<section class=\"graph-legend\"></section>');\n      var firstRender = true;\n      var ctrl = scope.ctrl;\n      var panel = ctrl.panel;\n      var data;\n      var seriesList;\n      var i;\n\n      ctrl.events.on('render', function() {\n        data = ctrl.series;\n        if (data) {\n          for(var i in data) {\n            data[i].color = ctrl.data[i].color;\n          }\n          render();\n        }\n      });\n\n      function getSeriesIndexForElement(el) {\n        return el.parents('[data-series-index]').data('series-index');\n      }\n\n      function toggleSeries(e) {\n        var el = $(e.currentTarget);\n        var index = getSeriesIndexForElement(el);\n        var seriesInfo = seriesList[index];\n        var scrollPosition = $($container.children('tbody')).scrollTop();\n        ctrl.toggleSeries(seriesInfo);\n        $($container.children('tbody')).scrollTop(scrollPosition);\n      }\n\n      function sortLegend(e) {\n        var el = $(e.currentTarget);\n        var stat = el.data('stat');\n\n        if (stat !== panel.legend.sort) { panel.legend.sortDesc = null; }\n\n        // if already sort ascending, disable sorting\n        if (panel.legend.sortDesc === false) {\n          panel.legend.sort = null;\n          panel.legend.sortDesc = null;\n          ctrl.render();\n          return;\n        }\n\n        panel.legend.sortDesc = !panel.legend.sortDesc;\n        panel.legend.sort = stat;\n        ctrl.render();\n      }\n\n      function getLegendHeaderHtml(statName) {\n        var name = statName;\n\n        if (panel.legend.header) {\n          name = panel.legend.header;\n        }\n\n        var html = '<th class=\"pointer\" data-stat=\"' + statName + '\">' + name;\n\n        if (panel.legend.sort === statName) {\n          var cssClass = panel.legend.sortDesc ? 'fa fa-caret-down' : 'fa fa-caret-up' ;\n          html += ' <span class=\"' + cssClass + '\"></span>';\n        }\n\n        return html + '</th>';\n      }\n\n      function getLegendPercentageHtml(statName) {\n        var name = 'percentage';\n        var html = '<th class=\"pointer\" data-stat=\"' + statName + '\">' + name;\n\n        if (panel.legend.sort === statName) {\n          var cssClass = panel.legend.sortDesc ? 'fa fa-caret-down' : 'fa fa-caret-up' ;\n          html += ' <span class=\"' + cssClass + '\"></span>';\n        }\n\n        return html + '</th>';\n      }\n\n      function openColorSelector(e) {\n        // if we clicked inside poup container ignore click\n        if ($(e.target).parents('.popover').length) {\n          return;\n        }\n\n        var el = $(e.currentTarget).find('.fa-minus');\n        var index = getSeriesIndexForElement(el);\n        var series = seriesList[index];\n\n        $timeout(function() {\n          popoverSrv.show({\n            element: el[0],\n            position: 'bottom center',\n            template: '<series-color-picker series=\"series\" onToggleAxis=\"toggleAxis\" onColorChange=\"colorSelected\">' +\n            '</series-color-picker>',\n            openOn: 'hover',\n            model: {\n              autoClose: true,\n              series: series,\n              toggleAxis: function() {},\n              colorSelected: function(color) {\n                ctrl.changeSeriesColor(series, color);\n              }\n            },\n          });\n        });\n      }\n\n      function render() {\n        if(panel.legendType === 'On graph') {\n          $container.empty();\n          return;\n        }\n\n        if (firstRender) {\n          elem.append($container);\n          $container.on('click', '.graph-legend-icon', openColorSelector);\n          $container.on('click', '.graph-legend-alias', toggleSeries);\n          $container.on('click', 'th', sortLegend);\n          firstRender = false;\n        }\n\n        seriesList = data;\n\n        $container.empty();\n\n        var showValues = panel.legend.values || panel.legend.percentage;\n        var tableLayout = (\n            panel.legendType === 'Under graph' ||\n            panel.legendType === 'Right side'\n            ) && showValues;\n\n        $container.toggleClass('graph-legend-table', tableLayout);\n\n        var legendHeader;\n        if (tableLayout) {\n          var header = '<tr><th colspan=\"2\" style=\"text-align:left\"></th>';\n          if (panel.legend.values) {\n              header += getLegendHeaderHtml(ctrl.panel.valueName);\n          }\n          if (panel.legend.percentage) {\n            header += getLegendPercentageHtml(ctrl.panel.valueName);\n          }\n          header += '</tr>';\n          legendHeader = $(header);\n        }\n\n        if (panel.legend.sort) {\n          seriesList = _.sortBy(seriesList, function(series) {\n            return series.stats[panel.legend.sort];\n          });\n          if (panel.legend.sortDesc) {\n            seriesList = seriesList.reverse();\n          }\n        }\n\n        if (panel.legend.percentage) {\n          var total = 0;\n          for (i = 0; i < seriesList.length; i++) {\n            total += seriesList[i].stats[ctrl.panel.valueName];\n          }\n        }\n\n        var seriesShown = 0;\n        var seriesElements = [];\n\n        for (i = 0; i < seriesList.length; i++) {\n          var series = seriesList[i];\n          var seriesData = ctrl.data[i];\n\n          // ignore empty series\n          if (panel.legend.hideEmpty && series.allIsNull) {\n            continue;\n          }\n          // ignore series excluded via override\n          if (!series.legend) {\n            continue;\n          }\n\n          var decimal = 2;\n          if (ctrl.panel.legend.percentageDecimals) {\n            decimal = ctrl.panel.legend.percentageDecimals;\n          }\n\n          var html = '<div class=\"graph-legend-series';\n          if (ctrl.hiddenSeries[series.alias]) { html += ' graph-legend-series-hidden'; }\n          html += '\" data-series-index=\"' + i + '\">';\n          html += '<span class=\"graph-legend-icon\" style=\"float:none;\">';\n          html += '<i class=\"fa fa-minus pointer\" style=\"color:' + seriesData.color + '\"></i>';\n          html += '</span>';\n\n          html += '<a class=\"graph-legend-alias\" style=\"float:none;\">' + seriesData.label + '</a>';\n\n          if (showValues && tableLayout) {\n            var value = series.stats[ctrl.panel.valueName];\n            if (panel.legend.values) {\n              html += '<div class=\"graph-legend-value\">' + ctrl.formatValue(value) + '</div>';\n            }\n            if (total) {\n              var pvalue = ((value / total) * 100).toFixed(decimal) + '%';\n              html += '<div class=\"graph-legend-value\">' + pvalue +'</div>';\n            }\n          }\n\n          html += '</div>';\n\n          seriesElements.push($(html));\n          seriesShown++;\n        }\n\n        if (tableLayout) {\n          var maxHeight = ctrl.height;\n\n          if (panel.legendType === 'Under graph') {\n            maxHeight = maxHeight/2;\n          }\n\n          var topPadding = 6;\n          var tbodyElem = $('<tbody></tbody>');\n          tbodyElem.css(\"max-height\", maxHeight - topPadding);\n          tbodyElem.append(legendHeader);\n          tbodyElem.append(seriesElements);\n          $container.append(tbodyElem);\n        } else {\n          $container.append(seriesElements);\n        }\n      }\n    }\n  };\n});\n\n\n"]}